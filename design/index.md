
# UI交互—多端协同解决方案

---


## 问题域
<!--```-->
<!--洞察当前趋势下特定形态所存在的问题和挑战，比如对应的市场环境、客户需求、用户体验、产品设计、架构等发生了哪些关键的变化；-->
<!--结合洞察分析，给出一些实际的现象、案例或场景；-->
<!--```-->
从财务软件时代到ERP时代，电脑的键盘、鼠标和显示器一直是重要的输入输出设备。随着数字化时代的到来，各种智能终端设备越来越多，计算力越来越强，并且各有特长。如何把大量的终端设备有机的整合起来，为用户提供更好的UI交互体验呢？

```
让我们一起进入新UI交互——多端协同交互的时代吧！
```
### 1. 什么是基于多端协同的UI交互？
新UI交互与传统UI交互最大的不同，就是软件输入输出的能力不同。

在传统软件中，主要依靠键盘和鼠标进行数据输入，电脑的计算结果通过显示器进行呈现，如图：
![传统模式](http://47.92.67.238:7080/res/mtl/pc1.jpg)

而基于多端协同的新UI交互，则是灵活的使用不同设备的不同能力，把输入输出进行了大幅度的扩展，以实现方便用户使用的目标。例如，使用手机为企业软件扫描采集纸质单据数据；使用扫码枪快速采集二维码信息；使用显示器和TV大屏联合显示报表数据等等。

![多端模式](http://47.92.67.238:7080/res/mtl/pc3.jpg)


### 2. 典型业务场景

多端协同能够支撑的业务场景很多，以下只是我们进行抽象的典型场景。

**2.1 通过多端设备==扩展输入==场景**

   - 使用手机摄像头扫描纸质单据，进行快捷录入。
   - 使用手机定位信息，为PC提供当前位置信息。
   - 使用手机触屏功能，提供手写签名信息。
   

**2.2 通过多端设备==扩展输出==场景**

   + 通过大屏展示报表等数据
   + 向其它设备，如手机、手表等发送消息
   + 控制其它设备的行为
   
   
**2.3 通过云端==同步多端==数据**

   + 文件共享。可以在PC或手机上，直接将文件分享到其它设备。

[ff](http://47.92.67.238:7080/res/docs/story1.md)

[ff  dd](./practice1.md)

### 3. 面临的挑战

想要发挥多端协同的优势之前，我们还面临一些挑战

1. 设备系统多样性

    多端意味着多种设备协同运转。这些设备上面运行着不同的系统。PC上面有macOS、Windows、Linux，移动设备有Android、iOS等等。同一种操作系统还有各种版本。如何才能保障这么多的系统统一协同工作呢？

2. 设备接入与安全

    在不同的设备上，有的设备相对安全，比如制造中的手持设备、扫码枪等，有的设备安全性很低，如个人电脑，被Root过的手机系统。如何统一的管理这些设备的生命周期、运行环境？提供简单的接入、注销方法？实时监控设备的接入和运行就变得尤其重要。

3. 弱网与离线

    客户端的网络环境往往很差，网络慢甚至没有网络。如果在弱网环境下保证数据安全，同时尽可能给予用户良好的使用体验？

4. 高并发的数据传输与处理

    多个设备开始协同运行后。实时高并发的数据传输也带来了很大的挑战。一个事务可能分布在两个甚至更多的设备上。如何保障数据的传输稳定，低延迟？如何处理异步数据的回滚？如何在高频数据和低频数据之间进行缓冲处理成为难题！


---



## 解决方案
<!--```-->
<!--提出解决问题的基本思路、设计方案和落地路径；-->
<!--在不遵守中台对应标准和规范、不采用中台支撑服务的情况下，以上方案能够帮助相关方掌握解决问题的基本思路，但落地成本及后续持续优化代价较大；-->
<!--```-->
一个典型的多端协同方案必然包括云端和泛型SDK两个部分。

### 1. 多端协同云端架构

云端主要包含基础构架和扩展构架两个部分

![云端架构](http://47.92.67.238:7080/res/mtl/cloud.jpg)

1. **基础构架**

    基础构架是多端协同的基础能力，是多端协同必不可少的部分。它主要为多端协同框架提供设备管理、用户管理、消息中心、消息推送、安全权限、连接管理，共6大能力。

	+ 设备管理。负责管理设备的生命周期，从设备接入到注销；设备在线/离线的状态切换；设备的ID标识；虚拟对象设备和设备数据的持久化。
	+ 用户管理。负责管理用户、机构、角色基本信息。也可以接入第三方用户信息系统。管理用户与设备的绑定关系。一个用户允许绑定多台设备，也允许多个用户绑定到一台设备。
	+ 消息中心。负责消息的订阅、发布、创建、回调、持久化。
	+ 消息推送。提供多种消息推送的方式，包括长连接推送、离线推送、短信推送、邮件推送、消息回调等。
	+ 安全权限。负责安全密钥、数据加解密、负责消息过滤、前置Filter等安全相关的处理。
	+ 连接管理。负责长连接对象的管理，包括创建、销毁长连接对象。提供按用户、设备寻找长连接的服务。



2. **扩展服务**

	扩展服务就是提供调用第三方服务或系统的能力。
	
	多端协同解决方案往往需要与业务系统、bPaaS等能力连接起来，才能发挥最大的价值。比如，在OCR扫描的案例中，就需要业务系统对扫描到的单据数据进行结构化处理，才能形成有意义的业务数据。所以，多端协同云端必须具备业务系统接入或调用的能力，为云端提供众多业务功能。


### 2. 多端协同客户端构架

客户端需要支持多个平台。一般来说需要提供Android、iOS、Web三个平台的SDK。随着微信小程序的兴起，一些简单的操作也会提供微信小程序的SDK。

就单个平台的SDK而言，分为Core SDK和 API SDK两部分
+ Core SDK提供多端协同的基本能力。如连接、设备注册、收发消息等。
+ API SDK则根据不同的客户端提供不同的能力。比打印机的SDK提供打印、纸张设置的能力；手机的SDK提供摄像头、定位等能力等等。

如图：
![客户端架构](http://47.92.67.238:7080/res/mtl/client.jpg)

1. **Core SDK**
	
	Core SDK提供设备管理、连接管理、消息中心、安全、离线数据、事务管理等基本能力。
	   + 设备管理。产生设备ID标识，注册、注销等等；
	   + 连接管理。管理长连接的连接、断开、重连、心跳等操作。另外保活也是连接管理的重要能力；
	   + 消息中心。管理本台设备的消息数据。通常持久化到本地的轻量级数据 库中，如SQLite；
	   + 安全权限。客户端的安全极其重要，数据的加密，反Root等是客户端必须的能力；
	   + 离线管理。客户端与服务端不同，网络环境常常恶劣。在重要消息的发送，接收，设备状态变化等关键场景需要处理在线、断网、重连等多种情况；
	   + 事务管理。配合云端的跨设备事务，同步回滚失败的事务；

2. **API SDK**

	API SDK是根据不同设备端提供不同的API。对于手机设备来说，通常会提供包括语音、OCR、摄像、人脸认证、消息等常用能力。

3. **APP SDK**

	APP SDK是面向领域的扩展。比如在小友投屏解决方案中，提供的投屏的API，如搜索设备、设备状态、投文件、投图片、投视频、同频投等API


---


<!--```-->
<!--提出解决方案对应的参考实现、相应标准和规范；-->
<!--如果遵循这套标准和规范，具体实现可以不使用中台提供的支撑服务，后续也可低成本实现迁移和升级；-->
<!--```-->
### 1. 云端标准实现方案

云端实现有多种技术支撑，如图：
![云端架构](http://47.92.67.238:7080/res/mtl/cloud_tech.png)

1. 长连接模块
	
	使用Apache-Mina框架
	
	MINA基于java NIO提供了TCP连接的管理，NIO的典型特点是异步无阻塞、采用数据驱动的方式，MINA提供基于filters的扩展方式，网络处理和业务处理解耦。 MINA框架封装了数据的接收和发送能力，只需要实现filter对网络数据进行处理（包括压缩和解压缩、加密解密等），经过filter之后的数据进入handler进行处理，通过实现MINA的IoHandler接口实现自己的业务处理逻辑。
	![长连接模块](http://47.92.67.238:7080/res/mtl/ssl.png)

2. 短连接模块

	使用SpringMvc框架+restapi
	
	SpringMvc框架是spring框架针对mvc设计思想的一种实现，mvc是较为成熟的模型-视图-控制器的设计思想，将前端展示和后端处理解耦。 restful风格的api是业界使用较多的一种短连接设计模式，其典型特征是uri+method的方式对用户请求进行分发，uri用来表示服务器的资源，method表示请求类型，支持POST（新增）、PUT（修改）、DELETE（删除）、GET（获取）
	![长连接模块](http://47.92.67.238:7080/res/mtl/restful.png)

3. 消息队列MQ-Kafka

	消息队列使用Kafka实现，kafka是一个高吞吐率、具备容错能力的分布式消息系统，基于生产者-消费者的服务模型，具备高扩展性、可恢复性和极佳的峰值处理能力，吞吐率能达到10w/s。 kafka相较于传统MQ的优点是既可以保证消息的消费顺序又支持集群部署。传统的MQ生产者面对多个消费者的情况下，虽然生产者是按照顺序分发消息，但是消费者并不能保证完全按照相应的顺序收到分发的消息。 kakfa的消息是基于topic的，可以针对每个topic建立多个分区partition，每个topic的消息每个partition都相当于传统MQ的一条通道。Kafka可以在多个consumer组并发的情况下提供较好的有序性和负载均衡。将每个分区分只分发给一个consumer组，这样一个分区就只被这个组的一个consumer消费，就可以顺序的消费这个分区的消息。因为有多个分区，依然可以在多个consumer组之间进行负载均衡。

4. 数据加密

	加密包括传输加密和存储加密，在长短链接都使用安全连接的基础上对传输数据进行二次加密能够确保将信息泄露的风险降到最低。加解密使用AES，服务器会针对每个用户生成有一定有效期限的密钥对，公钥在用户登录时进行获取或者更新，私钥保存在服务器。 用户在发送长短链接数据时，使用公钥对数据进行加密，服务器收到数据后先使用请求用户的私钥进行解密，处理之后将返回的数据使用接收方的私钥进行加密，发送给接收方，数据库存储使用固定密钥对进行加解密，避免客户端在获取历史信息的时候出现问题。
	![长连接模块](http://47.92.67.238:7080/res/mtl/encrpt.png)

5. 设备唯一性的保证

	由客户端获取设备的唯一编码，移动端采用获取IMEI序列号，对于TV等非移动端设备，可以采取生成固定UUID的方式，在软件卸载的时候将UUID写入文件中，在下次重新安装时读取，最大限度的保证设备和设备码的一一对应关系。

6. 设备接入认证

	设备端使用服务器颁发的clientId和clientSecret，携带唯一编码和应用ID向服务器获取AuthCode，服务器通过判断clientId和clientSecret的合法性返回给设备AuthCode。随后设备使用AuthCode进行认证，每个不同的设备由于设备ID不相同，因此获取到的AuthCode也不相同，确保了数据的安全隔离。

7. 消息必达和时效性的保证

	消息必达的保证：使用在线实时推送和离线消息保存的方式，对于要求必达的消息，在用户或设备在线的情况下，使用kakfa进行消息推送，kafka自身具备容错能力，消费者在未commit的情况下，kafka会自动重新分发消息给消费者，当消费者服务异常时，kafka会将消息保存到硬盘，在消费者重新启动的时候会继续消费未消费的消息。用户或设备离线的情况下，服务器会自动保存消息到离线表中，在用户或设备再次连接时推送离线消息。 消息时效性的保证：消息处理的主要瓶颈在于消息的处理和持久化，相关的处理需要加载用户或者设备的数据等，这部分热点数据将会使用redis进行缓存，前面提到的mongo数据库由于也是偏内存型的数据库，存储和查询都相对高效。

8. 安全性保证

	长连接使用SSL，短连接使用Https，数据的传输在压缩的同时，使用加密服务按照上述提到的方式进行加密，连接加密+数据加密双重加密确保数据的安全传输。

9. 容灾能力

	使用微服务的架构，服务多节点部署。 dubbo和kafka本身都具备较好的容灾能力，dubbo的重试机制能够确保在所有服务提供者异常的情况下进行重试，在某个服务提供者异常的情况下，dubbo的负载均衡策略会自动发现其他的可用服务。 kafka会在消费者异常的情况下持久化消息到硬盘上。


### 2. 客户端标准实现方案

1. 设备管理

	+ **设备标识ID**
	
	客户端可以采用两种方式来保证设备唯一性。
	第一种是硬件芯片的方式，每个芯片都拥有唯一ID，获取到的芯片ID即为设备唯一ID。
	第二种是获取设备的device_id，即根据不同的手机设备返回IMEI，MEID或者ESN码。当获取不到device_id时，例如平板电脑等，客户端使用UDID作为设备唯一ID，UUID的全称是Universally Unique Identifier，即通用唯一识别码。为了保证即使客户端被删除也不会改变UUID，我们把UUID存在keyChain中。keyChain是一个相对独立的空间，当程序替换，删除时并不会删除keyChain的内容。进入app的时候存入UUID，以后的时候读取他。就算卸载，读取出来的值还是第一次进入app的时候的UUID，实现了设备的唯一标识符。
	
	+ **注册/注销**
	
	客户端提供API调用云端进行设备注册/注销操作。参数通常包括AppId、UserId、DeviceId
	
	+ **绑定/解除绑定**
	
	客户端提供API调用云端进行设备绑定/解除绑定操作。参数通常包括AppId、UserId、DeviceId

2. 连接管理

	重点介绍一下长连接的实现方法，客户端的长连接可以采用GCDAsyncSocket。
	
	GCDAsyncSocket是CocoaAsyncSocket第三方库中的其中一个类，可以对GCDAsyncSocket做了一层封装调用，它包含了建连、断开、重连、心跳、自定义请求等。
	首先创建一个socket，设置socket属性，绑定IP、端口等信息到socket上，连接服务器，收发数据。这样就建立了一个socket连接。socket连接就是长连接，长连接可能因为各种环境因素断开，如服务器down机、网络故障或者两者长时间没有传输数据等等，这就需要对长连接进行保活。
	我们使用心跳机制来达到长连接保活的目的，客户端每隔一个时间间隔发生一个心跳包给服务器，同时启动一个超时定时器，服务器接收到心跳包，会回应一个包，若客户端收到服务器返回的应答包，则说明服务器正常，删除超时定时器，若客户端的超时定时器超时，没有收到应答包，则说明服务器出现问题，进行后续的逻辑处理。
	
	另外，连接的保活是一个很重要的内容。而Android、iOS、macOS的保活技术各不相同。需要另开新坑去讨论。

3. 消息中心
	
	**消息存储** 客户端的消息中心通常可以采用SQLite来进行数据持久化。
	sqlite具备零配置(Zero Configuration)、紧凑（compactness）、可移植(Portability)等特点，特别适时在客户端作为一个轻量级数据存储。
	
	**消息发送/接收** 调用云端服务完成消息发送和接收。在网络中断时，使用离线管理来处理离线状态下的发送问题。

4. 安全权限

	对于客户端来说，安全一般包含网络安全和应用安全。
	
	**网络安全**
	
	- 提供HTTPS、MQTT保证网络安全
	- 长短链接都使用安全连接的基础上对传输数据进行二次加密能够确保将信息泄露的风险降到最低。加解密使用AES，每次登录在服务器获取用户生成有一定有效期限的密钥对，公钥在用户登录时进行获取或者更新，私钥保存在服务器。 用户在发送长短链接数据时，使用公钥对数据进行加密发送，收到数据保存数据库，数据库存储使用固定密钥对进行加解密。
	- 更严格的请求，可以使用非对称加密公钥RSA加密的方式
	
	**应用安全**
	可以对应用进行安全加固，防止应用被恶意破解
	
	- 防止应用被二次打包、恶意篡改、内存截取等风险
	- 通过签名校验，有效避免应用被二次打包，杜绝盗版应用
	- 对内存数据进行变换处理和动态跟踪，防止内存数据被修改和获取
	- 进行代码加密压缩，防止还原真实代码逻辑，避免应用被复制
	- 多重手段防止代码注入，避免外挂、木马或窃取账号密码等恶意行为
	 
	另外，对安全还有本地数据安全和环境安全，这些与应用本身的安全相关性更大一些，就不在多端协同方案中讨论了。

5. 离线管理
	
	离线管理分别网络状态管理、上传离线管理和下行离线管理。
	
	**网络状态**。网络发生Wifi切换、中断、重连时，会广播消息。以通知使用者改变网络策略。
	
	**上传离线管理**。主要解决发送消息时，网络中断或超时导致无法上传的情况。发送时，消息主体会先进入本地的离线数据库中，并设置状态为待发送。再使用连接管理中的长短连接进行发送。如果发现网络中断，则到发送动作设置到Job队列中，回调发送失败。如果用户有侦听回调可以选择中止发送或延时发送，如果选择延时发送时，则会在网络恢复时，重新尝试发送，但不再回调。程序员只能通过API检测该消息是否成功发送。
	
	**下行离线管理**。主要应用于获取消息时，网络中断或超时导致无法获取的情况。这时，会回调网络中断。用户可以使用离线方法获取数据，以保持程序继续运行。

6. 事务管理

	事务采用跨端事务管理，在某个端开启事务后，创建一个事务提交的回调接口，在后台等待另一个端返回调用事件。事件分为提交、回滚和超时三种。另一个端发送提交事件时，本端也同步进行提交操作，如果提交失败通知第三方提交失败。另一个端发送回滚时，本端也同步进行回滚操作，回滚失败时发送通知。超时为自发性事件，允许事务开启时设置超时时间，当超时时间到达时，启动超时事件，本端可以根据业务要求回滚或提交数据，同时结束事务等待回调。


## 标准与规范
### 1. 硬件设备标准
### 2. 设备接入规范
### 3. 多端能力扩展的标准



## 中台支撑服务
<!--```-->
<!--提供具体的支撑服务；-->
<!--提供相应的最佳实践案例，包括覆盖的场景，支持的特性等；-->
<!--```-->

### CoreSDK

### 扩展SDK
![人脸认证]()

### 中台公网服务

在平台的多端协同解决方案中，集平台多年开发各种客户端、云端的经验，形成了多端协同的完整解决方案。
我们提供了
+ 设备的快速接入能力
+ 设备间访问、控制能力
+ 消息传输和同步能力
+ 安全的设备访问环境
覆盖多端协同解决方案的各个环节。

### 1. 多终端设备的快速接入
+ 提供多种终端SDK，一行代码，一分钟接入云端
+ 支持多种网络协议。HTTP(s)、MQTT、SSL/TLS
+ 快速设备ID标识


### 2. 多终端设备访问与控制
接入云端，始终受控
- 设备生命周期管理。注册、删除、禁用
- 设备状态管理。On-line，Off-line
- 设备权限管理。用户绑定、数据访问权限 
- 设备升级。强制升级、热修复、OTA
- 虚拟设备对象建模。


### 3. 多终端设备消息传输与同步
丰富的消息传递，满足协同业务需求

- 支持长短连接。心跳、自动重连。
- 离线设备消息推送。
- 丰富的消息类型。即时消息、透传消息、事务消息、业务消息、短信、邮件
- 双向消息。调用反馈。
- 富消息呈现。消息模版、事件。


### 4. 安全与权限
- 设备安全认证。重点设备实现一机一密（硬件KEY加密）。
- 采用SSL/TLS安全传输。
- 细粒度消息安全控制。可以按业务、用户、设备组进行授权管理
- 

### 5. 静默升级
- 云平台支持多端设备静默升级SDK，功能不断完善。


## 最佳实践

### 1. 事务性业务操作的典型场景

+ 参与角色：员工、部门经理
+ 参与设备：手机、PC、小友智能终端、TV
+ 业务背景：员工填报***费用报销单***，部门经理审批。

***主要流程*** 

![长连接模块](http://47.92.67.238:7080/res/mtl/story1.png)


**场景1 员工登录报销系统**

在传统业务中，登录一般可以采用用户名+密码+验证码的登录方式。在多端协同的应用中，我们登录的方式得到大幅的提升，常见的有：
+ 手机扫描二维码登录
+ 人脸认证登录
+ 指纹认证登录
+ NFC、蓝牙等各种近距离无线通讯技术

本场景中，我们使用了人脸认证登录。在PC上，员工点击人脸登录按钮。绑定的手机启动人脸认证界面，获取照片后到云平台人脸库进行认证。

> 扩展：在安全性要求更高的场景，我们可以采用NFC、蓝牙等连接加密的硬件进行高级安全认证。

**场景2 填写费用报销单**

在传统业务中，填写单据真心是一件费心费力的事情，其中以报销单最为麻烦，又是上传电子发票，又要填写费用发生的时间地点金额等等。
但在多端协同的帮助下。我们使用外部设备帮助我们更方便的录入单据。
+ 使用OCR技术，识别单据自动填单
+ 扫描PC端单据上的二维码，手机上传附件

**场景3 部门经理审批单据**

+ 消息触达

员工在PC上提交报销单后，应用消息直接发送到部门经理桌面上的小友智能终端上。

+ VUI语音交互
+ TV大屏同步显示

小友智能终端语音提示，『您有一张待审批的单据』同步在小友屏上显示单据信息。
部门经理看了看单据信息，想了解一下部门的费用使用情况。不需要动手，语音对小友说，『麻烦看看本部门的费用情况』。小友经后台查询，语音播报『本部门的加班餐费还剩3500元，部门活动费还剩2800元……』，同步在部门经理办公室的TV大屏上投射部门费用表。
部门经理发现费用还够，就说『好的，同意报销』。小友回答『收到，报销单已审批』

**场景4 单据云打印**

+ 消息触达

部门经理审批通过后，多端协同服务器将审批通过的消息发送到员工的手机上（使用消息触达产品，可以通过友空间、微信、短信、邮件等多种方式通知到员工）。

![长连接模块](http://47.92.67.238:7080/res/mtl/notice.jpg)

+ 云打印 

员工可以点查看，查看消息。也可以点击打印，通过***多端协同产品***将单据发送到打印机，直接打印。

在多端协同解决方案的支持下，企业业务就是这么简单。
